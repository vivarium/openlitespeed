#!/bin/sh

EXECUTABLE=@CMAKE_INSTALL_PREFIX@/bin/openlitespeed
CONF_DIR=@CMAKE_INSTALL_PREFIX@/@CONF_DIR@
TMP_DIR=@TMP_DIR@
DESC="openlitespeed"

if [ -f "CONF_DIR"/lsws_env ] ; then
    if ! ./"CONF_DIR"/lsws_env 2>/dev/null ; then
        ./"CONF_DIR"/lsws_env
    fi
fi

# if the lsws_env is empty or not exist, still need to set the default values
if [ "x$PIDFILE" = "x" ] ; then 
    PIDFILE=@PID_DIR@/lshttpd.pid
    GRACEFUL_PIDFILE=@PID_DIR@/graceful.pid
fi

RESTART_LOG="@LOG_DIR@/lsrestart.log"
if [ ! -x "$EXECUTABLE" ]; then
    echo "[ERROR] Cannot find $EXECUTABLE"
    exit 1
fi

SYS_NAME="uname -s"
if [ "x$SYS_NAME" = "xFreeBSD" ] || [ "x$SYS_NAME" = "xDarwin" ] ; then
    PS_CMD="ps -ax"
else
    PS_CMD="ps -ef"
fi

test_running()
{
  RUNNING=0
  if [ -f $PIDFILE ]; then
    FPID="cat $PIDFILE"
    if [ "x$FPID" != "x" ]; then
        if [ ! kill -0 "$FPID" 2>/dev/null ]; then
            RUNNING=1
            PID=$FPID
        fi
    fi
  fi

  RESTARTING=0
  if [ -f "$TMP_DIR/.restart" ]; then
    RESTARTING=1
  fi
}

ret=0

killwatch()
{
        WATCH_PROCS=$($PS_CMD | grep wswatch.sh | grep -v grep | wc -l)
        if [ $WATCH_PROCS -gt 0 ]; then
                pkill wswatch.sh
        fi
}


start()
{
    killwatch
    if [ -f $PIDFILE ]; then
        PID=$(cat $PIDFILE)
    else
        PID=""
    fi
    
    export OLS_PID_FILE=$PIDFILE
    $EXECUTABLE
    ret=$?


    if [ $ret -eq 0 ]; then
        NEW_PID=$(cat $PIDFILE)
        if [ "x$NEW_PID" = "x$PID" ] || [ "x$NEW_PID" = "x" ]; then
            sleep 1
            NEW_PID=$(cat $PIDFILE)
        fi
        echo "[OK] $DESC: pid=$NEW_PID."
        test_running
        if [ "x$WSWATCH" = "x1" ]; then
            ./wswatch.sh &
        fi
    else
        echo "[ERROR] Failed to start $DESC!"
    fi
}


stop()
{
    killwatch
    kill -USR2 $PID
    kill $PID
    
    test_running
    if [ $RUNNING -eq 0 ]; then
        echo "[OK] $DESC: stopped."
    else
        for i in {1..15}
        do
            sleep 1
            test_running

            if [ $RUNNING -eq 1 ]; then
                if [ "$i" = "14" ] || [ "$i" = "15" ] ; then
                    kill -9 $PID
                fi
            else
                break
            fi
        done
        
        test_running
        if [ $RUNNING -eq 1 ]; then
            echo "[ERROR] can not kill $DESC"
        else
            echo "[OK] $DESC: stopped."
        fi
    fi

}

delay_stop()
{
    killwatch
    kill -HUP $PID
    ret=$?
    if  [ $ret -eq 0 ]; then
        echo "[OK] $DESC: graceful stop."
    else
        echo "[ERROR] can not kill $DESC"
    fi
}



do_restart()
{
    if [ $RUNNING -eq 1 ]; then
        kill -USR1 $PID
        ret=$?
        if  [ $ret -ne 0 ]; then
            echo "[ERROR] cannot gracefully restart $DESC"
        else
            echo "[OK] Send SIGUSR1 to $PID"
        fi
    else
        start
    fi
}

log7080()
{
    if [ "x$SYS_NAME" = "xLinux" ]; then
        echo "checking port 7080 usage with netstat" >> $RESTART_LOG
        netstat -anp | grep 7080 >> $RESTART_LOG
        echo "checking port 7080 usage with lsof" >> $RESTART_LOG
        lsof -i TCP:7080 >> $RESTART_LOG
    fi
}

restart()
{
    SPID=$PID
    TRY=1
    if [ $RUNNING -eq 1 ]; then
        do_restart
        if [ $RESTARTING -eq 1 ]; then
            exit 0
        fi
        sleep 2
        test_running
    else
        if [ $RESTARTING -eq 1 ]; then
            if [ -f $GRACEFUL_PIDFILE ]; then
                GPID="cat $GRACEFUL_PIDFILE"
                if [ "x$GPID" != 'x' ]; then
                    if [ $GPID -ne 0 ] && [ $GPID -ne 1 ]; then
                        pkill -9 $EXECUTABLE
                    fi
                fi
            fi
        fi
        start
        sleep 2
        test_running
    fi
    while [ $TRY -lt 15 ] && [ "x$PID" = "x$SPID" ]; do
        TRY="expr $TRY + 1"
        sleep 1
        test_running
    done 

    if [ $RUNNING -eq 0 ]; then

        echo "LSWS does not restart properly, check port 7080" >> $RESTART_LOG
        #log7080
        pkill -9 $EXECUTABLE
        sleep 1
        echo "check port 7080 after kill all $EXECUTABLE processes " >> $RESTART_LOG
        #log7080
        start
    fi
}

reload()
{
    restart
}

help() {
    echo $"Usage: $PROG {start|stop|restart|reload|condrestrt|try-restart|status|help}"
    cat <<EOF

start       - start web server
stop        - stop web server
restart     - gracefully restart web server with zero down time
reload      - same as restart
condrestart - gracefully restart web server if server is running
try-restart - same as condrestart
status      - show service status
help        - this screen

EOF
}

test_running

date >> $RESTART_LOG
echo "$1, lshttpd running: $RUNNING" >> $RESTART_LOG

case "$1" in 
    start|restart)
        restart
        ;;
    condrestart|try-restart)
        if [ $RUNNING -eq 1 ]; then
            restart
        fi
        ;;
    status)
        if [ $RUNNING -eq 1 ]; then
            echo "$DESC is running with PID $PID."
        else
            echo "[ERROR] $DESC is not running."
        fi
        ;;
    stop)
        if [ $RUNNING -eq 0 ]; then
            sleep 1
            test_running
        fi
        if [ $RUNNING -eq 1 ]; then
            stop
        else
            echo "[ERROR] $DESC is not running."
            ret=1
        fi
        ;;
    delay-stop)
        if [ $RUNNING -eq 0 ]; then
            sleep 1
            test_running
        fi
        if [ $RUNNING -eq 1 ]; then
            delay_stop
        else
            echo "[ERROR] $DESC is not running."
            ret=1
        fi
        ;;    
    stophttpd)
        if [ $RUNNING -eq 1 ]; then
            kill $PID
        fi
        ;;
    reload)
        if [ $RUNNING -eq 1 ]; then
            reload
        else
            echo "[ERROR] $DESC is not running."
            ret=2
        fi
        ;;
    *)
        help
        ret=3
        ;;
esac

exit $ret
